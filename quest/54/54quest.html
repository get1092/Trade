<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 페이지</title>
    <link rel="stylesheet" href="./54.css">
    <link rel="stylesheet" href="../omr/test2.css">
    <style>
        .container {
            display: grid;
            grid-template-columns: 4fr 1fr;
            gap: 0px;
            height: 100vh;
        }

        .quiz,
        .cbt {
            overflow-y: auto;
            padding: 20px;
        }

        .omr strong {
            cursor: pointer;
        }

        .omr label {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="cbt">
        <div class="cbt__aside">
            <div class="cbt__info">
                <div>
                    <button class="cbt__submit">제출하기</button>
                    <span class="cbt__time">2시간 00분</span>
                </div>
                <div>
                    <div class="cbt__score">
                        <span>전체 문제수 : <em class="cbt__length">120</em>문항</span>
                        <span>남은 문제수 : <em class="cbt__rest">120</em>문항</span><br>
                        <span>점수 : <em class="cbt__end__score"> </em></span>
                    </div>
                </div>
            </div>
            <div class="cbt__omr">
                <div id="cla1">
                    <h3>무역규범</h3>
                </div>
                <div id="cla2">
                    <h3>무역결제</h3>
                </div>
                <div id="cla3">
                    <h3>무역계약</h3>
                </div>
                <div id="cla4">
                    <h3>무역영어</h3>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="quiz">
                <h2 class="quiz__title">국제무역사 54회</h2>
                <h3 class="subQuizTitle"></h3>
                <div class="quiz__question">
                    <img id="quizImage" src="" alt="문제 이미지">
                </div>
                <div class="quiz__choice">
                    <label for="choice1">
                        <input type="radio" id="choice1" name="choice" value="1">
                        <span></span>
                    </label>
                    <label for="choice2">
                        <input type="radio" id="choice2" name="choice" value="2">
                        <span></span>
                    </label>
                    <label for="choice3">
                        <input type="radio" id="choice3" name="choice" value="3">
                        <span></span>
                    </label>
                    <label for="choice4">
                        <input type="radio" id="choice4" name="choice" value="4">
                        <span></span>
                    </label>
                </div>
                <div class="quiz__answer">
                    <button id="prevQuizButton" class="btn prev">이전 문제</button>
                    <button id="nextQuizButton" class="btn next">다음 문제</button>
                </div>
            </div>
        </div>

        <script>
            const folderDescriptions = {
                'cla1': '무역규범',
                'cla2': '무역결제',
                'cla3': '무역계약',
                'cla4': '무역영어'
            };

            function generateQuizInfo(numImages, numFolders) {
                const quizInfo = [];
                for (let j = 1; j <= numFolders; j++) {
                    for (let i = 1; i <= numImages; i++) {
                        quizInfo.push({
                            imgSrc: `Trade/test54data/cla${j}/image${i}.png`,
                            imgAlt: `문제 이미지 ${i} from cla${j}`,
                            answer: Math.floor(Math.random() * 4) + 1,
                            folder: `cla${j}`
                        });
                    }
                }
                return quizInfo;
            }

            const quizInfo = generateQuizInfo(30, 4);
            const userAnswers = new Array(quizInfo.length).fill(null);
            const quizImage = document.getElementById("quizImage");
            const subQuizTitle = document.querySelector(".subQuizTitle");
            let currentQuizIndex = 0;

            function updateQuiz(index) {
                const quiz = quizInfo[index];
                quizImage.src = quiz.imgSrc;
                quizImage.alt = quiz.imgAlt;
                subQuizTitle.textContent = folderDescriptions[quiz.folder];
                const radioButtons = document.querySelectorAll('input[name="choice"]');
                radioButtons.forEach((button, idx) => {
                    button.checked = (idx + 1) === userAnswers[index];
                });
                updateOMR(index);
            }

            function updateOMR(index) {
                const quiz = quizInfo[index];
                const selectedAnswer = userAnswers[index];
                if (selectedAnswer !== null) {
                    const omrInputs = document.querySelectorAll(`#${quiz.folder} input[name="question${quiz.folder}_${index % 30 + 1}"]`);
                    omrInputs.forEach(input => {
                        input.checked = input.value == selectedAnswer;
                    });
                }
            }

            function updateQuizFromOMR(index, selectedAnswer) {
                userAnswers[index] = selectedAnswer;
                updateQuiz(index);
            }

            document.addEventListener("DOMContentLoaded", function () {
                createQuestions('cla1', 30);
                createQuestions('cla2', 30);
                createQuestions('cla3', 30);
                createQuestions('cla4', 30);
                updateQuiz(0);
                attachEventListeners();
                startTimer(120, document.querySelector('.cbt__time'));
            });

            function attachEventListeners() {
                document.querySelectorAll('.quiz__choice input[type="radio"]').forEach((button, idx) => {
                    button.addEventListener('change', () => {
                        userAnswers[currentQuizIndex] = idx + 1;
                        updateOMR(currentQuizIndex);
                        updateRemainingQuestions();
                    });
                });

                document.getElementById("nextQuizButton").addEventListener("click", function () {
                    if (currentQuizIndex < quizInfo.length - 1) {
                        currentQuizIndex++;
                        updateQuiz(currentQuizIndex);
                        document.getElementById("prevQuizButton").disabled = false;
                    }
                    if (currentQuizIndex >= quizInfo.length - 1) {
                        this.disabled = true;
                    }
                });

                document.getElementById("prevQuizButton").addEventListener("click", function () {
                    if (currentQuizIndex > 0) {
                        currentQuizIndex--;
                        updateQuiz(currentQuizIndex);
                        document.getElementById("nextQuizButton").disabled = false;
                    }
                    if (currentQuizIndex <= 0) {
                        this.disabled = true;
                    }
                });

                document.querySelector(".cbt__submit").addEventListener("click", async function () {
                    try {
                        const answers = await fetchAnswers();
                        const score = calculateScore(answers);
                        document.querySelector('.cbt__end__score').textContent = score.toFixed(0);
                        alert(`시험 제출 완료! 점수: ${score.toFixed(0)}점`);
                    } catch (error) {
                        alert('답안을 가져오는 도중 문제가 발생했습니다. 다시 시도해주세요.');
                    }
                });
            }

            function createQuestions(sectionId, numQuestions) {
                const section = document.getElementById(sectionId);
                for (let i = 1; i <= numQuestions; i++) {
                    const omrDiv = document.createElement('div');
                    omrDiv.className = 'omr';
                    omrDiv.innerHTML = `
                        <strong>${i}</strong>
                        <input type="radio" id="${sectionId}_${i}_1" name="question${sectionId}_${i}" value="1">
                        <label for="${sectionId}_${i}_1"><span class="label-inner">1</span></label>
                        <input type="radio" id="${sectionId}_${i}_2" name="question${sectionId}_${i}" value="2">
                        <label for="${sectionId}_${i}_2"><span class="label-inner">2</span></label>
                        <input type="radio" id="${sectionId}_${i}_3" name="question${sectionId}_${i}" value="3">
                        <label for="${sectionId}_${i}_3"><span class="label-inner">3</span></label>
                        <input type="radio" id="${sectionId}_${i}_4" name="question${sectionId}_${i}" value="4">
                        <label for="${sectionId}_${i}_4"><span class="label-inner">4</span></label>
                    `;
                    section.appendChild(omrDiv);

                    omrDiv.querySelectorAll('label, strong').forEach(element => {
                        element.addEventListener('click', () => {
                            const questionIndex = (parseInt(sectionId.replace('cla', '')) - 1) * numQuestions + (i - 1);
                            currentQuizIndex = questionIndex;
                            updateQuiz(currentQuizIndex);
                        });
                    });

                    Array.from(omrDiv.querySelectorAll('input[type="radio"]')).forEach(input => {
                        input.addEventListener('change', () => {
                            const questionIndex = (parseInt(sectionId.replace('cla', '')) - 1) * numQuestions + (i - 1);
                            const selectedAnswer = parseInt(input.value);
                            userAnswers[questionIndex] = selectedAnswer;
                            updateQuizFromOMR(questionIndex, selectedAnswer); // OMR에서 선택 시 문제 업데이트
                            updateRemainingQuestions();
                        });
                    });
                }
            }

            function updateRemainingQuestions() {
                const totalQuestions = parseInt(document.querySelector('.cbt__length').textContent, 10);
                const answeredQuestions = userAnswers.filter(answer => answer !== null).length;
                const remainingQuestions = totalQuestions - answeredQuestions;
                document.querySelector('.cbt__rest').textContent = remainingQuestions;
            }

            function startTimer(duration, display) {
                let timer = duration, hours, minutes;
                const interval = setInterval(() => {
                    hours = parseInt(timer / 60, 10);
                    minutes = timer % 60;

                    hours = hours < 10 ? "0" + hours : hours;
                    minutes = minutes < 10 ? "0" + minutes : minutes;

                    display.textContent = hours + "시간 " + minutes + "분";

                    if (--timer < 0) {
                        clearInterval(interval);
                        alert("시간 초과!");
                    }
                }, 60000); // 감소하는 시간 간격을 60000ms, 즉 1분으로 설정
            }
        </script>
    </div>
</body>

</html>
